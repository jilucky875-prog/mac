name: macOS UI (VNC via Serveo)

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable VNC (Screen Sharing)
        shell: bash
        run: |
          set -euo pipefail

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -restart -agent

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw -vncpw "${{ secrets.VNC_PASSWORD }}"

          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          echo "VNC enabled on localhost:5900"

      - name: Open Serveo tunnel to VNC (5900)
        shell: bash
        run: |
          set -euo pipefail

          SUB="${{ secrets.SERVEO_SUBDOMAIN }}"
          if [ -z "${SUB}" ]; then
            echo "SERVEO_SUBDOMAIN empty => random subdomain will be assigned by serveo."
            REMOTE="0:localhost:5900"
          else
            REMOTE="${SUB}:5900:localhost:5900"
          fi

          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
            -R "${REMOTE}" serveo.net | tee serveo.log

      - name: Notes
        if: always()
        run: |
          echo "Check logs above for the Serveo forwarding line."
          echo "Then connect via any VNC viewer to <subdomain>.serveo.net:5900"
