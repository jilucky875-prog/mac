name: macOS Native VNC (Secure Endgame)

on: workflow_dispatch

concurrency:
  group: "mac-native-vnc"
  cancel-in-progress: false

jobs:
  macos-vnc-pro:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      - name: üîî Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üçé *Mac Starting...*\nMode: Native VNC (Secure Endgame)"}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: ‚öôÔ∏è System Prep & Wake Screen
        run: |
          sudo mdutil -i off -a
          sudo pmset -a displaysleep 0 disksleep 0 sleep 0
          caffeinate -u -t 10 &
          
          cat << 'EOF' > ram_monitor.sh
          #!/bin/bash
          while true; do
            FREE_PAGES=$(vm_stat | grep "Pages free" | awk '{print $3}' | sed 's/\.//')
            if [ "$FREE_PAGES" -lt 200000 ]; then sudo purge; fi
            sleep 30
          done
          EOF
          chmod +x ram_monitor.sh
          ./ram_monitor.sh &

      - name: üîê Setup VNC (Secure Hex Injection & Reset)
        env:
          VNC_PASS: ${{ secrets.VNC_PASSWORD }}
        run: |
          echo "1. Generating strict Apple Legacy VNC Hex from Secret..."
          # Fetching secret safely via environment variable to avoid bash interpolation bugs
          sudo VNC_PASS="$VNC_PASS" python3 - <<'EOF'
          import os
          key = bytes.fromhex("1734516E8BA8C5E2FF1C39567390ADCA")
          # Retrieve password securely, default to a fallback if secret is empty
          raw_pwd = os.environ.get("VNC_PASS", "123456")
          pwd = raw_pwd.encode('utf-8')[:8].ljust(8, b"\x00")
          p = pwd + (b"\x00" * 8)
          obf = bytes([key[i] ^ p[i] for i in range(16)])
          hexstr = obf.hex().upper()
          with open("/Library/Preferences/com.apple.VNCSettings.txt", "w") as f:
              f.write(hexstr + "\n")
          EOF
          
          echo "2. Applying Strict Permissions to Password File..."
          sudo chown root:wheel /Library/Preferences/com.apple.VNCSettings.txt
          sudo chmod 600 /Library/Preferences/com.apple.VNCSettings.txt

          echo "3. Configuring ARD Agent (Bypassing Buggy Password Flags)..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -stop || true
          # Note: Intentionally excluding -setvncpw so macOS reads our perfect Python hash
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -allowAccessFor -allUsers -configure -access -on -privs -all -configure -clientopts -setreqperm -reqperm no -setvnclegacy -vnclegacy yes -restart -agent

          echo "4. Hard Resetting Screen Sharing Daemon..."
          sudo launchctl bootout system /System/Library/LaunchDaemons/com.apple.screensharing.plist || true
          sleep 2
          sudo launchctl bootstrap system /System/Library/LaunchDaemons/com.apple.screensharing.plist || true

          echo "5. Waking Mac Display..."
          osascript -e 'tell application "System Events" to key code 123' || true

          echo "6. Verifying Service Port..."
          sleep 5
          sudo lsof -nP -iTCP:5900 -sTCP:LISTEN || netstat -an | grep 5900 || echo "‚ö†Ô∏è Port 5900 check failed!"

      - name: üíæ Setup GDrive Sync
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG }}
        run: |
          brew install rclone
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_DATA" > ~/.config/rclone/rclone.conf
          mkdir -p ~/Desktop/MyWorkspace
          rclone mkdir gdrive:RDP_Backup || true
          rclone copy gdrive:RDP_Backup ~/Desktop/MyWorkspace

      - name: üîå Start Pinggy TCP Tunnel
        run: |
          echo "Starting Pinggy Tunnel..."
          TUNNEL_DEST="tcp@a.pinggy.io"
          ssh -p 443 -R0:localhost:5900 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 $TUNNEL_DEST > pinggy.log 2>&1 &

          sleep 12
          URL=$(grep -o "tcp://[0-9a-zA-Z.-]*:[0-9]*" pinggy.log | head -n 1)
          CLEAN_URL=$(echo $URL | sed 's/tcp:\/\///')

          curl -X POST -H "Content-Type: application/json" \
          -d "{\"message\": \"üçé *Mac Ready!*\nüñ•Ô∏è VNC Address: \`$CLEAN_URL\`\nüë§ User: (Leave Blank)\nüîë Pass: (Your GitHub Secret)\"}" \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üîÑ Keep-Alive & Auto-Backup
        run: |
          cleanup() {
              rclone sync ~/Desktop/MyWorkspace gdrive:RDP_Backup
              exit 0
          }
          trap 'cleanup' SIGINT SIGTERM EXIT
          START=$(date +%s)
          while true; do
              NOW=$(date +%s); DIFF=$((NOW - START))
              if [ $DIFF -ge 21000 ]; then exit 0; fi
              if [ $((DIFF % 300)) -lt 60 ] && [ $DIFF -gt 100 ]; then
                  rclone sync ~/Desktop/MyWorkspace gdrive:RDP_Backup
              fi
              sleep 60
          done
