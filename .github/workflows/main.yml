name: macOS Native VNC

on: workflow_dispatch

jobs:
  macos-vnc:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      - name: üîî Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d '{"message": "üçé *Mac Starting...*\nMode: Native VNC"}' \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üë§ Create Admin User (Authentication Fix)
        run: |
          # System password change karne ki jagah hum apna naya user banayenge
          echo "Creating secure user 'remoteuser'..."
          sudo sysadminctl -addUser remoteuser -fullName "Remote Admin" -password "123456" -admin

      - name: ‚öôÔ∏è Configure VNC for New User
        run: |
          echo "Enabling Screen Sharing for 'remoteuser'..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -specifiedUsers
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -access -on -privs -all -users remoteuser
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          # Force load the daemon
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true

      - name: üíæ Setup GDrive
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG }}
        run: |
          brew install rclone
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_DATA" > ~/.config/rclone/rclone.conf
          mkdir -p ~/Desktop/MyWorkspace
          rclone mkdir gdrive:RDP_Backup || true
          rclone copy gdrive:RDP_Backup ~/Desktop/MyWorkspace

      - name: üîå Start Ngrok Tunnel (TCP)
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok/ngrok/ngrok
          ngrok config add-authtoken $NGROK_TOKEN
          # VNC Port 5900 ko TCP tunnel kar rahe hain
          ngrok tcp 5900 --log=stdout > ngrok.log &
          
          echo "Waiting for Tunnel..."
          sleep 10
          
          # Extract URL
          URL=$(grep -o "tcp://[0-9a-z.-]*:[0-9]*" ngrok.log)
          
          if [ -z "$URL" ]; then
            echo "‚ö†Ô∏è Error: Ngrok URL not found. Check token."
            cat ngrok.log
            exit 1
          fi
          
          # Remove 'tcp://' prefix for clean address
          CLEAN_URL=$(echo $URL | sed 's/tcp:\/\///')
          
          echo "==================================================="
          echo "‚úÖ VNC ADDRESS: $CLEAN_URL"
          echo "üë§ USERNAME: remoteuser"
          echo "üîë PASSWORD: 123456"
          echo "==================================================="
          
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"message\": \"üçé *Mac Ready!*\nüñ•Ô∏è VNC Address: \`$CLEAN_URL\`\nüë§ User: \`remoteuser\`\nüîë Pass: \`123456\`\"}" \
          ${{ secrets.N8N_WEBHOOK }} || true

      - name: üîÑ Keep-Alive Loop
        run: |
          cleanup() {
              rclone sync ~/Desktop/MyWorkspace gdrive:RDP_Backup
              exit 0
          }
          trap 'cleanup' SIGINT SIGTERM EXIT
          START=$(date +%s)
          while true; do
              NOW=$(date +%s); DIFF=$((NOW - START))
              if [ $DIFF -ge 21000 ]; then exit 0; fi
              if [ $((DIFF % 300)) -lt 60 ] && [ $DIFF -gt 100 ]; then
                  rclone sync ~/Desktop/MyWorkspace gdrive:RDP_Backup
              fi
              sleep 60
          done
