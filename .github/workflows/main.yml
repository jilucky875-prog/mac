- name: üîê Setup VNC Server & noVNC
        run: |
          echo "Injecting Secure VNC Password..."
          sudo python3 -c '
          import os
          key = bytes.fromhex("1734516E8BA8C5E2FF1C39567390ADCA")
          pwd = b"123456".ljust(8, b"\x00")[:8]
          obf = bytes(a ^ b for a, b in zip(pwd, key))
          
          with open("/Library/Preferences/com.apple.VNCSettings.txt", "wb") as f:
              f.write(obf)
          user_path = "/Users/runner/Library/Preferences/com.apple.VNCSettings.txt"
          with open(user_path, "wb") as f:
              f.write(obf)
          '
          
          echo "Configuring VNC Server Permissions..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -allUsers -privs -all
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes
          
          echo "Activating & Restarting VNC Service..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -restart -agent
          
          echo "Setting up Web UI (noVNC)..."
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 8080 &

      - name: üåê Start Cloudflare Tunnel (Smart Wait)
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:8080 > cloudflare.log 2>&1 &
          
          echo "Waiting for Cloudflare to generate URL..."
          # Smart Loop: Har 2 second me check karega, maximum 20 baar (40 seconds total)
          for i in {1..20}; do
            sleep 2
            URL=$(grep -o 'https://[a-zA-Z0-9.-]*\.trycloudflare.com' cloudflare.log | head -n 1)
            if [ ! -z "$URL" ]; then
              break
            fi
          done
          
          # Agar 40 seconds baad bhi link nahi aaya, toh error show karega
          if [ -z "$URL" ]; then
            echo "‚ö†Ô∏è ERROR: Cloudflare failed to generate tunnel. Showing logs:"
            cat cloudflare.log
            exit 1
          fi
          
          FINAL_URL="$URL/vnc.html"
          
          echo "===================================================================="
          echo "üåê LIVE URL: $FINAL_URL"
          echo "‚ö†Ô∏è USERNAME: (Leave Blank)"
          echo "üîë PASSWORD: 123456"
          echo "===================================================================="
          
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"message\": \"üçé *Mac Workspace Ready!*\nüîó $FINAL_URL\nüîë Pass: \`123456\`\"}" \
          ${{ secrets.N8N_WEBHOOK }} || true
