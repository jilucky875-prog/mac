name: macOS Native VNC (Anti-Crash Fix)

on: workflow_dispatch

jobs:
  macos-vnc-pro:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      - name: üîî Notify Start
        run: |
          curl -sS -X POST -H "Content-Type: application/json" \
            -d "{\"message\":\"üçé *Mac Starting...*\nMode: Anti-Crash Resolution Fix\"}" \
            "${{ secrets.N8N_WEBHOOK }}" || true

      - name: ‚öôÔ∏è System Prep
        run: |
          sudo mdutil -i off -a || true
          sudo pmset -a displaysleep 0 disksleep 0 sleep 0 || true
          caffeinate -u -t 10 &

      - name: üîê Setup VNC (Resolution & Session Fix)
        env:
          VNC_PASS: ${{ secrets.VNC_PASSWORD }}
        run: |
          if [ -z "$VNC_PASS" ]; then echo "ERROR: VNC_PASSWORD missing"; exit 1; fi

          echo "1) Cleaning stuck sessions..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -stop || true
          sudo pkill screensharingd || true

          echo "2) Configuring VNC with reqperm=no..."
          # Force resolution and bypass permission prompts
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate \
            -configure -allowAccessFor -allUsers \
            -configure -access -on -privs -all \
            -configure -clientopts -setreqperm -reqperm no -setvnclegacy -vnclegacy yes -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent

          echo "3) Forcing Window Server to render pixels..."
          # Setting a standard resolution helps the VNC buffer
          sudo /usr/bin/defaults write /Library/Preferences/com.apple.windowserver.plist DisplayResolutionEnabled -bool true
          
          echo "4) Waking the Console User session..."
          # Nudging the runner user specifically
          sudo launchctl enable system/com.apple.screensharing || true
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true
          
          # Virtual Key Press to trigger render
          osascript -e 'tell application "System Events" to key code 123' || true

      - name: üíæ Setup GDrive Sync
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG }}
        run: |
          brew install rclone
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG_DATA" > ~/.config/rclone/rclone.conf
          mkdir -p ~/Desktop/MyWorkspace
          rclone copy gdrive:RDP_Backup ~/Desktop/MyWorkspace || true

      - name: üîå Start Pinggy TCP Tunnel
        run: |
          TUNNEL_DEST="tcp@a.pinggy.io"
          ssh -p 443 -R0:localhost:5900 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 "$TUNNEL_DEST" > pinggy.log 2>&1 &
          
          sleep 12
          URL=$(grep -o "tcp://[0-9a-zA-Z.-]*:[0-9]*" pinggy.log | head -n 1)
          CLEAN_URL="${URL#tcp://}"
          
          curl -sS -X POST -H "Content-Type: application/json" \
            -d "{\"message\":\"üçé *Mac Ready!*\nüñ•Ô∏è VNC Address: \`$CLEAN_URL\`\nüîë Pass: (Use Secret)\"}" \
            "${{ secrets.N8N_WEBHOOK }}" || true

      - name: üîÑ Keep-Alive & Auto-Backup
        run: |
          cleanup() { rclone sync ~/Desktop/MyWorkspace gdrive:RDP_Backup || true; exit 0; }
          trap 'cleanup' SIGINT SIGTERM EXIT
          START=$(date +%s)
          while true; do
            NOW=$(date +%s); DIFF=$((NOW - START))
            if [ $DIFF -ge 21000 ]; then exit 0; fi
            if [ $((DIFF % 300)) -lt 60 ] && [ $DIFF -gt 100 ]; then
              rclone sync ~/Desktop/MyWorkspace gdrive:RDP_Backup || true
            fi
            sleep 60
          done
