name: macOS UI (VNC via Serveo - Private TCP)

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable VNC (Screen Sharing)
        shell: bash
        run: |
          set -euo pipefail

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -restart -agent

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw -vncpw "${{ secrets.VNC_PASSWORD }}"

          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          echo "VNC enabled on localhost:5900"

      - name: Open Serveo Private TCP tunnel (keeps job running)
        shell: bash
        run: |
          set -euo pipefail

          ALIAS="${{ secrets.SERVEO_ALIAS }}"
          if [ -z "${ALIAS}" ]; then
            ALIAS="macvnc"
          fi

          echo "Use this ALIAS on your PC: ${ALIAS}"
          echo "Next: run 'ssh -L 5902:${ALIAS}:5901 serveo.net' on your PC, then connect VNC to 127.0.0.1:5902"
          
          # Private TCP forwarding (NOT public random port)
          ssh -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=30 -o ServerAliveCountMax=3 \
              -N -R "${ALIAS}:5901:localhost:5900" serveo.net
