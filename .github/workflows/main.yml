name: macOS UI (VNC over Tailscale)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  macos-vnc:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Connect runner to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          hostname: gha-macos-vnc
          version: latest

      - name: Create VNC user (system auth)
        shell: bash
        run: |
          set -euo pipefail
          U=vncuser

          if ! id -u "$U" >/dev/null 2>&1; then
            NEXT_UID="$(dscl . -list /Users UniqueID | awk '{print $2}' | sort -n | tail -1)"
            NEXT_UID="$((NEXT_UID+1))"
            sudo dscl . -create "/Users/$U"
            sudo dscl . -create "/Users/$U" UserShell /bin/bash
            sudo dscl . -create "/Users/$U" RealName "VNC User"
            sudo dscl . -create "/Users/$U" UniqueID "$NEXT_UID"
            sudo dscl . -create "/Users/$U" PrimaryGroupID 20
            sudo dscl . -create "/Users/$U" NFSHomeDirectory "/Users/$U"
            sudo dscl . -passwd "/Users/$U" "${{ secrets.VNC_USER_PASSWORD }}"
            sudo createhomedir -c -u "$U" >/dev/null
          fi

          sudo dseditgroup -o edit -a "$U" -t user com.apple.access_screen_sharing || true

      - name: Enable Screen Sharing / VNC
        shell: bash
        run: |
          set -euo pipefail

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -allowAccessFor -specifiedUsers -users vncuser \
            -access -on -privs -all -restart -agent

          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true

          echo "Tailscale IPs:"
          tailscale ip -4 || true
          tailscale ip -6 || true
          echo "Connect VNC to: <TAILSCALE_IPV4>:5900"
          echo "Username: vncuser"
          echo "Password: VNC_USER_PASSWORD secret"
          echo "Stop: Cancel the workflow when done."
          
          # Keep alive
          sleep 21600
